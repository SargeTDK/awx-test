- name: Connect to win servers
  hosts: winservers
  tasks:
    - name: Create User Koks
      microsoft.ad.user:
        name: '{{ lastname }} {{ firstname }}'
        firstname: '{{ firstname }}'
        lastname: '{{ lastname }}'
        display_name: '{{ lastname }} {{ firstname }}'
        password: password
        upn: '{{ lastname.lower() }}.{{ firstname[0].lower() }}@example.com'          # Generate UPN with variable and python
        sam_account_name: '{{ lastname.lower() }}.{{ firstname[0].lower() }}'
        email: '{{ lastname.lower() }}.{{ firstname[0].lower() }}@example.com'
        path: path
        state: present
      vars:
        lastname: Perisval
        firstname: Koks
        password: 123qweASD
        path: OU=EXAMPLE.COM,DC=example,DC=com
      register: result

- name: Test
  hosts: winservers
  tasks:
    - name: Return result
      ansible.builtin.debug:
        msg: '{{ result }}'
